<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Medikinet Tagebuch ‚Äì Cloud</title>
  <style>
    :root {
      color-scheme: light;
      font-family: "Segoe UI", system-ui, -apple-system, sans-serif;
      --bg: #f5f7fb;
      --fg: #1f2937;
      --card: #ffffff;
      --primary: #4f46e5;
      --primary-dark: #3b33c4;
      --border: #e2e7f5;
      --radius: 20px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 24px 16px 64px;
      background: var(--bg);
      color: var(--fg);
      display: flex;
      justify-content: center;
      min-height: 100vh;
    }

    .app {
      width: min(960px, 100%);
      display: grid;
      gap: 24px;
    }

    header {
      text-align: center;
      display: grid;
      gap: 12px;
    }

    header h1 {
      margin: 0;
      font-size: clamp(1.9rem, 2.6vw, 2.9rem);
    }

    header p {
      margin: 0;
      color: #4b5563;
      line-height: 1.5;
    }

    .card {
      background: var(--card);
      border-radius: var(--radius);
      padding: clamp(16px, 2vw, 28px);
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.08);
      display: grid;
      gap: 16px;
    }

    form {
      display: grid;
      gap: 18px;
    }

    .grid {
      display: grid;
      gap: 16px;
    }

    .grid.two {
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }

    label {
      display: grid;
      gap: 6px;
      font-weight: 600;
      font-size: 15px;
    }

    select,
    input[type="date"],
    textarea {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 12px;
      font: inherit;
      transition: border 0.2s, box-shadow 0.2s;
      background: #fdfdff;
    }

    select:focus,
    input[type="date"]:focus,
    textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.15);
    }

    textarea {
      min-height: 96px;
      resize: vertical;
    }

    .checkbox-row {
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 600;
      font-size: 15px;
    }

    .checkbox-row input {
      width: 20px;
      height: 20px;
      accent-color: var(--primary);
    }

    fieldset.checkbox-cluster {
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 14px 16px 18px;
      display: grid;
      gap: 12px;
    }

    fieldset.checkbox-cluster legend {
      font-weight: 700;
      font-size: 0.95rem;
      padding: 0 8px;
    }

    .checkbox-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 12px 18px;
    }

    .checkbox-grid .checkbox-row {
      padding: 4px 0;
    }

    .tag-list {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border-radius: 999px;
      padding: 4px 10px;
      background: rgba(79, 70, 229, 0.12);
      color: var(--primary);
      font-size: 0.85rem;
      font-weight: 600;
    }

    .muted {
      color: #6b7280;
    }

    .table-action {
      background: transparent;
      border: 1px solid rgba(79, 70, 229, 0.3);
      color: var(--primary);
      border-radius: 999px;
      padding: 6px 12px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease, color 0.2s ease;
    }

    .table-action:hover {
      background: rgba(79, 70, 229, 0.08);
    }

    .entry-card .table-action {
      justify-self: start;
    }

    .actions {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: flex-end;
    }

    .history-actions {
      justify-content: space-between;
      align-items: center;
    }

    .history-meta {
      flex: 1;
      min-width: 200px;
      color: #4b5563;
      font-size: 0.9rem;
      font-weight: 600;
    }

    button {
      padding: 10px 16px;
      border-radius: 999px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.1s ease, box-shadow 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    button.primary {
      background: var(--primary);
      color: white;
      box-shadow: 0 10px 20px rgba(79, 70, 229, 0.25);
    }

    button.primary:hover {
      background: var(--primary-dark);
    }

    button.secondary {
      background: #e5e7ff;
      color: var(--primary);
    }

    button.danger {
      background: #fee2e2;
      color: #b91c1c;
    }

    button:active {
      transform: scale(0.98);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(79, 70, 229, 0.12);
      color: var(--primary);
      border-radius: 999px;
      padding: 6px 12px;
      font-weight: 600;
      font-size: 0.85rem;
      width: fit-content;
    }

    .info-banner {
      display: grid;
      gap: 4px;
      font-size: 0.95rem;
      padding: 12px 16px;
      border-radius: 12px;
      border: 1px solid rgba(79, 70, 229, 0.2);
      background: rgba(79, 70, 229, 0.08);
    }

    .status {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 16px;
      border-radius: 12px;
      font-weight: 600;
      line-height: 1.4;
    }

    .status[data-tone="info"] {
      background: #eef2ff;
      color: #3730a3;
    }

    .status[data-tone="success"] {
      background: #ecfdf5;
      color: #047857;
    }

    .status[data-tone="error"] {
      background: #fef2f2;
      color: #b91c1c;
    }

    .table-wrapper {
      border-radius: 16px;
      overflow-x: auto;
      background: rgba(79, 70, 229, 0.03);
      padding: 2px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.95rem;
      min-width: 720px;
    }

    th,
    td {
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      text-align: left;
    }

    th {
      background: #eef1ff;
      font-weight: 700;
    }

    tbody tr:hover {
      background: rgba(79, 70, 229, 0.05);
    }

    .empty-state {
      text-align: center;
      padding: 28px 16px;
      color: #6b7280;
      font-weight: 600;
    }

    .entries-list {
      display: none;
      gap: 12px;
    }

    .entry-card {
      border: 1px solid rgba(79, 70, 229, 0.12);
      border-radius: 16px;
      padding: 16px;
      background: white;
      display: grid;
      gap: 12px;
      box-shadow: 0 12px 24px rgba(15, 23, 42, 0.06);
    }

    .entry-card__header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 8px;
      font-weight: 700;
    }

    .entry-card__mood {
      color: var(--primary);
    }

    .entry-card dl {
      display: grid;
      gap: 8px;
      margin: 0;
    }

    .entry-card dl div {
      display: grid;
      gap: 4px;
    }

    .entry-card dt {
      font-weight: 600;
      color: #4b5563;
      font-size: 0.9rem;
    }

    .entry-card dd {
      margin: 0;
      font-size: 0.95rem;
      line-height: 1.4;
    }

    @media (max-width: 900px) {
      body {
        padding: 20px 14px 48px;
      }
    }

    @media (max-width: 720px) {
      .grid.two {
        grid-template-columns: 1fr;
      }

      .actions {
        justify-content: center;
      }

      .actions button {
        flex: 1 1 200px;
        justify-content: center;
      }

      .table-wrapper {
        display: none;
      }

      .entries-list {
        display: grid;
      }

      .history-meta {
        text-align: center;
      }
    }

    @media (max-width: 600px) {
      body {
        padding: 16px 12px 40px;
      }

      header p {
        font-size: 0.95rem;
      }
    }

    @media (max-width: 480px) {
      header h1 {
        font-size: 1.75rem;
      }

      .card {
        padding: 18px 16px;
      }

      button {
        width: 100%;
        justify-content: center;
      }

      .actions {
        gap: 10px;
      }
    }
  </style>
  <script src="./cloud-config.js"></script>
</head>
<body>
  <div class="app">
      <header>
        <h1>‚òÅÔ∏è Medikinet-Tagebuch (Cloud)</h1>
        <p>Diese Variante synchronisiert alle Eintr√§ge mit einem JSONBin. Lege den Bin vorab an und trage deine Schl√ºssel in <code>cloud-config.js</code> ein.</p>
      </header>

    <section class="card" aria-labelledby="cloud-info">
      <div class="badge" id="cloud-info">Cloud-Speicher</div>
        <div class="info-banner">
          <strong>So funktioniert es:</strong>
          <span>‚Ä¢ Kopiere <code>cloud-config.example.js</code> zu <code>cloud-config.js</code> und hinterlege dort deine JSONBin-Bin-ID sowie den <code>X-Master-Key</code> (optional <code>X-Access-Key</code>).</span>
          <span>‚Ä¢ Lege bei <a href="https://jsonbin.io" target="_blank" rel="noopener">jsonbin.io</a> einen Bin mit dem Inhalt <code>{ "entries": [] }</code> an und notiere dir die erzeugte ID.</span>
          <span>‚Ä¢ Die API-Schl√ºssel findest du im JSONBin-Dashboard unter <em>API Keys</em>. Bewahre den Master Key sicher auf.</span>
          <span>‚Ä¢ Beim Speichern wird pro Datum √ºberschrieben; jeder Eintrag l√§sst sich einzeln wieder l√∂schen.</span>
        </div>
      <div class="status" id="cloud-status" role="status" aria-live="polite" data-tone="info">Warte auf Konfiguration‚Ä¶</div>
    </section>

    <section class="card" aria-labelledby="tagebuch-form">
      <div class="badge" id="tagebuch-form">Heutiger Eintrag</div>
      <form id="entry-form">
        <div class="grid two">
          <label>
            Datum
            <input type="date" id="datum" name="datum" required />
          </label>
          <label>
            Stimmung
            <select id="stimmung" name="stimmung" required>
              <option value="üòä Sehr gut">üòä Sehr gut</option>
              <option value="üôÇ Gut">üôÇ Gut</option>
              <option value="üòê Neutral">üòê Neutral</option>
              <option value="‚òπÔ∏è Schwankend">‚òπÔ∏è Schwankend</option>
              <option value="üò£ Herausfordernd">üò£ Herausfordernd</option>
            </select>
          </label>
          <label>
            Konzentration (Schule)
            <select id="konz" name="konz" required>
              <option value="üòä Sehr fokussiert">üòä Sehr fokussiert</option>
              <option value="üôÇ Gut fokussiert">üôÇ Gut fokussiert</option>
              <option value="üòê Mittel">üòê Mittel</option>
              <option value="‚òπÔ∏è Schwierig">‚òπÔ∏è Schwierig</option>
              <option value="üò£ Kaum m√∂glich">üò£ Kaum m√∂glich</option>
            </select>
          </label>
          <label>
            √úberreizung (Vormittag)
            <select id="vorm" name="vorm" required>
              <option value="üòä Sehr ruhig">üòä Sehr ruhig</option>
              <option value="üôÇ Gut reguliert">üôÇ Gut reguliert</option>
              <option value="üòê Leicht angespannt">üòê Leicht angespannt</option>
              <option value="‚òπÔ∏è Deutlich angespannt">‚òπÔ∏è Deutlich angespannt</option>
              <option value="üò£ Stark √ºberreizt">üò£ Stark √ºberreizt</option>
            </select>
          </label>
          <label>
            √úberreizung (Abend)
            <select id="abend" name="abend" required>
              <option value="üòä Sehr ruhig">üòä Sehr ruhig</option>
              <option value="üôÇ Gut reguliert">üôÇ Gut reguliert</option>
              <option value="üòê Leicht angespannt">üòê Leicht angespannt</option>
              <option value="‚òπÔ∏è Deutlich angespannt">‚òπÔ∏è Deutlich angespannt</option>
              <option value="üò£ Stark √ºberreizt">üò£ Stark √ºberreizt</option>
            </select>
          </label>
        </div>

        <fieldset class="checkbox-cluster">
          <legend>Besondere Beobachtungen heute</legend>
          <div class="checkbox-grid">
            <label class="checkbox-row" for="ausbr">
              <input type="checkbox" id="ausbr" name="ausbr" />
              Auff√§llige Ausbr√ºche
            </label>
            <label class="checkbox-row" for="kopfweh">
              <input type="checkbox" id="kopfweh" name="kopfweh" />
              Kopfweh
            </label>
            <label class="checkbox-row" for="bauchweh">
              <input type="checkbox" id="bauchweh" name="bauchweh" />
              Bauchweh
            </label>
            <label class="checkbox-row" for="schwindel">
              <input type="checkbox" id="schwindel" name="schwindel" />
              Schwindel
            </label>
          </div>
        </fieldset>

        <label>
          Auff√§lligkeiten &amp; Notizen
          <textarea id="auff" name="auff" placeholder="z. B. Kopfweh, Bauchweh, Einschlafschwierigkeiten..."></textarea>
        </label>

        <div class="actions">
          <button type="button" class="secondary" id="reset-btn">Formular leeren</button>
          <button type="submit" class="primary">‚òÅÔ∏è Eintrag speichern</button>
        </div>
      </form>
    </section>

    <section class="card" aria-labelledby="history-title">
      <div class="badge" id="history-title">Verlauf</div>
      <div class="actions history-actions">
        <span class="history-meta" id="history-meta" aria-live="polite"></span>
        <button type="button" class="secondary" id="export-btn">üìÅ Verlauf als CSV</button>
      </div>
      <div class="table-wrapper" aria-hidden="false">
        <table aria-live="polite" aria-describedby="history-title">
          <thead>
            <tr>
              <th>Datum</th>
              <th>Stimmung</th>
              <th>Konzentration</th>
              <th>√úberreizung (VM)</th>
              <th>√úberreizung (Ab)</th>
              <th>Ausbr√ºche</th>
              <th>Nebenwirkungen</th>
              <th>Notizen</th>
              <th>Aktion</th>
            </tr>
          </thead>
          <tbody id="entries-body"></tbody>
        </table>
      </div>
      <div class="entries-list" id="entries-list" role="list" aria-live="polite" aria-hidden="true"></div>
    </section>
  </div>

  <script type="module">
    const config = window.MEDIKINET_CLOUD_CONFIG || {};
    const API_BASE = "https://api.jsonbin.io/v3/b";

    const form = document.getElementById("entry-form");
    const entriesBody = document.getElementById("entries-body");
    const entriesList = document.getElementById("entries-list");
    const historyMeta = document.getElementById("history-meta");
    const resetBtn = document.getElementById("reset-btn");
    const exportBtn = document.getElementById("export-btn");
    const cloudStatus = document.getElementById("cloud-status");
    const tableWrapper = document.querySelector(".table-wrapper");

    const fields = [
      "datum",
      "stimmung",
      "konz",
      "vorm",
      "abend",
      "ausbr",
      "kopfweh",
      "bauchweh",
      "schwindel",
      "auff",
    ];

    const booleanFields = new Set(["ausbr", "kopfweh", "bauchweh", "schwindel"]);

    const today = new Date();
    let cachedEntries = [];
    let lastSyncedAt = null;

    const mobileQuery = window.matchMedia("(max-width: 720px)");

    function formatDateInput(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, "0");
      const day = String(date.getDate()).padStart(2, "0");
      return `${year}-${month}-${day}`;
    }

    function setDefaultDate() {
      const dateInput = document.getElementById("datum");
      if (!dateInput.value) {
        dateInput.value = formatDateInput(today);
      }
    }

    function setStatus(message, tone = "info") {
      if (!cloudStatus) return;
      cloudStatus.textContent = message;
      cloudStatus.setAttribute("data-tone", tone);
    }

    function toggleFormDisabled(disabled) {
      const controls = form?.querySelectorAll("input, select, textarea, button");
      controls?.forEach((control) => {
        control.disabled = disabled;
      });
    }

    function syncHistoryView() {
      const hideTable = mobileQuery.matches;
      if (tableWrapper) {
        tableWrapper.setAttribute("aria-hidden", hideTable ? "true" : "false");
      }
      if (entriesList) {
        entriesList.setAttribute("aria-hidden", hideTable ? "false" : "true");
      }
    }

    if (mobileQuery.addEventListener) {
      mobileQuery.addEventListener("change", syncHistoryView);
    } else if (mobileQuery.addListener) {
      mobileQuery.addListener(syncHistoryView);
    }

    function collectSideEffects(entry) {
      return [
        entry.kopfweh ? "Kopfweh" : null,
        entry.bauchweh ? "Bauchweh" : null,
        entry.schwindel ? "Schwindel" : null,
      ].filter(Boolean);
    }

    function formatSideEffectsText(entry) {
      const list = collectSideEffects(entry);
      return list.length ? list.join(", ") : "Keine";
    }

    function createSideEffectsTags(entry) {
      const list = collectSideEffects(entry);
      if (!list.length) {
        return '<span class="muted">Keine</span>';
      }
      return `<div class="tag-list">${list
        .map((label) => `<span class="tag">${label}</span>`)
        .join("")}</div>`;
    }

    function normalizeEntry(entry) {
      return {
        datum: entry.datum ?? "",
        stimmung: entry.stimmung ?? "",
        konz: entry.konz ?? "",
        vorm: entry.vorm ?? "",
        abend: entry.abend ?? "",
        ausbr: Boolean(entry.ausbr),
        kopfweh: Boolean(entry.kopfweh),
        bauchweh: Boolean(entry.bauchweh),
        schwindel: Boolean(entry.schwindel),
        auff: entry.auff ? entry.auff.toString() : "",
      };
    }

    function sortByDate(a, b) {
      if (!a?.datum) return -1;
      if (!b?.datum) return 1;
      return a.datum.localeCompare(b.datum);
    }

    function formatTimestamp(isoString) {
      if (!isoString) return null;
      const date = new Date(isoString);
      if (Number.isNaN(date.getTime())) return null;
      return date.toLocaleString("de-DE", {
        dateStyle: "short",
        timeStyle: "short",
      });
    }

    function buildHistorySummary(entries) {
      if (!entries.length) {
        return "Noch keine Eintr√§ge";
      }
      const first = entries[0]?.datum;
      const last = entries[entries.length - 1]?.datum;
      const range =
        first && last ? (first === last ? first : `${first} bis ${last}`) : "";
      const timestamp = formatTimestamp(lastSyncedAt);
      const base = range ? `${entries.length} Eintr√§ge (${range})` : `${entries.length} Eintr√§ge`;
      return timestamp ? `${base} ¬∑ Stand ${timestamp}` : base;
    }

    function buildStatusSummary(entries) {
      if (!entries.length) {
        return "Cloud verbunden. Noch keine Eintr√§ge gespeichert.";
      }
      return `Cloud synchronisiert ‚Äì ${buildHistorySummary(entries)}`;
    }

    function updateHistoryMeta(entries) {
      if (!historyMeta) return;
      if (!entries.length) {
        historyMeta.textContent = "Noch keine Eintr√§ge";
        return;
      }
      historyMeta.textContent = `Synchronisiert: ${buildHistorySummary(entries)}`;
    }

    function renderToDom(entries) {
      entriesBody.innerHTML = "";
      if (entriesList) {
        entriesList.innerHTML = "";
      }

      if (!entries.length) {
        entriesBody.innerHTML = `<tr class="empty-state"><td colspan="9">Noch keine Eintr√§ge gespeichert.</td></tr>`;
        if (entriesList) {
          entriesList.innerHTML = `<p class="empty-state" role="status">Noch keine Eintr√§ge gespeichert.</p>`;
        }
        updateHistoryMeta(entries);
        return;
      }

      for (const entry of entries) {
        const notesHtml = entry.auff ? entry.auff.replace(/\n/g, "<br>") : "";
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${entry.datum}</td>
          <td>${entry.stimmung}</td>
          <td>${entry.konz}</td>
          <td>${entry.vorm}</td>
          <td>${entry.abend}</td>
          <td>${entry.ausbr ? "‚úÖ Ja" : "‚ûñ Nein"}</td>
          <td>${formatSideEffectsText(entry)}</td>
          <td>${notesHtml}</td>
          <td><button type="button" class="table-action" data-entry-date="${entry.datum}" data-action="delete-entry">L√∂schen</button></td>
        `;
        entriesBody.appendChild(row);

        if (entriesList) {
          const card = document.createElement("article");
          card.className = "entry-card";
          card.setAttribute("role", "listitem");
          const notes = entry.auff ? entry.auff.replace(/\n/g, "<br>") : "Keine Notizen";
          card.innerHTML = `
            <div class="entry-card__header">
              <span class="entry-card__date">${entry.datum}</span>
              <span class="entry-card__mood">${entry.stimmung}</span>
            </div>
            <dl>
              <div>
                <dt>Konzentration</dt>
                <dd>${entry.konz}</dd>
              </div>
              <div>
                <dt>√úberreizung (Vormittag)</dt>
                <dd>${entry.vorm}</dd>
              </div>
              <div>
                <dt>√úberreizung (Abend)</dt>
                <dd>${entry.abend}</dd>
              </div>
              <div>
                <dt>Ausbr√ºche</dt>
                <dd>${entry.ausbr ? "‚úÖ Ja" : "‚ûñ Nein"}</dd>
              </div>
              <div>
                <dt>Nebenwirkungen</dt>
                <dd>${createSideEffectsTags(entry)}</dd>
              </div>
              <div>
                <dt>Notizen</dt>
                <dd>${notes}</dd>
              </div>
            </dl>
            <button type="button" class="table-action" data-entry-date="${entry.datum}" data-action="delete-entry">Eintrag l√∂schen</button>
          `;
          entriesList.appendChild(card);
        }
      }

      updateHistoryMeta(entries);
    }

    function buildHeaders(includeContentType = false) {
      const headers = {};
      if (config.masterKey) {
        headers["X-Master-Key"] = config.masterKey;
      }
      if (config.accessKey) {
        headers["X-Access-Key"] = config.accessKey;
      }
      if (includeContentType) {
        headers["Content-Type"] = "application/json";
      }
      return headers;
    }

    async function fetchFromJsonBin() {
      const url = `${API_BASE}/${config.binId}/latest`;
      const response = await fetch(url, { headers: buildHeaders() });
      if (response.status === 404) {
        throw new Error("Bin nicht gefunden (404). Bitte √ºberpr√ºfe deine JSONBin-ID.");
      }
      if (!response.ok) {
        const message = await response.text();
        throw new Error(message || `HTTP ${response.status}`);
      }
      const payload = await response.json();
      lastSyncedAt =
        payload.metadata?.updatedAt ||
        payload.metadata?.modifiedAt ||
        payload.metadata?.createdAt ||
        null;
      const entries = Array.isArray(payload.record?.entries) ? payload.record.entries : [];
      return entries.map(normalizeEntry).sort(sortByDate);
    }

    async function pushToJsonBin(entries) {
      const url = `${API_BASE}/${config.binId}`;
      const response = await fetch(url, {
        method: "PUT",
        headers: {
          ...buildHeaders(true),
          "X-Bin-Versioning": "false",
        },
        body: JSON.stringify({
          entries,
          updatedAt: new Date().toISOString(),
        }),
      });
      if (!response.ok) {
        const message = await response.text();
        throw new Error(message || `HTTP ${response.status}`);
      }
      const payload = await response.json();
      lastSyncedAt =
        payload.metadata?.updatedAt ||
        payload.metadata?.modifiedAt ||
        new Date().toISOString();
      const savedEntries = Array.isArray(payload.record?.entries) ? payload.record.entries : entries;
      return savedEntries.map(normalizeEntry).sort(sortByDate);
    }

    async function refreshEntries({ silent = false } = {}) {
      if (!silent) {
        setStatus("Synchronisiere mit JSONBin‚Ä¶", "info");
      }
      try {
        const entries = await fetchFromJsonBin();
        cachedEntries = entries;
        renderToDom(cachedEntries);
        if (!silent) {
          setStatus(buildStatusSummary(entries), "success");
        }
        return entries;
      } catch (error) {
        console.error("Fehler beim Laden", error);
        if (!silent) {
          setStatus(`Laden fehlgeschlagen: ${error.message}`, "error");
        }
        throw error;
      }
    }

    async function handleSubmit(event) {
      event.preventDefault();
      const formData = new FormData(form);
      const entry = {};

      for (const field of fields) {
        if (booleanFields.has(field)) {
          entry[field] = formData.get(field) === "on";
        } else {
          entry[field] = (formData.get(field) || "").toString().trim();
        }
      }

      toggleFormDisabled(true);
      setStatus("Speichere Eintrag‚Ä¶", "info");

      try {
        const latest = await fetchFromJsonBin();
        const next = [...latest];
        const index = next.findIndex((item) => item.datum === entry.datum);
        if (index >= 0) {
          next[index] = entry;
        } else {
          next.push(entry);
        }
        next.sort(sortByDate);

        const saved = await pushToJsonBin(next);
        cachedEntries = saved;
        renderToDom(cachedEntries);
        form.reset();
        setDefaultDate();
        setStatus(buildStatusSummary(cachedEntries), "success");
      } catch (error) {
        console.error("Fehler beim Speichern", error);
        setStatus(`Speichern fehlgeschlagen: ${error.message}`, "error");
      } finally {
        toggleFormDisabled(false);
      }
    }

    function handleReset() {
      form.reset();
      setDefaultDate();
    }

    function exportCsv() {
      if (!cachedEntries.length) {
        alert("Es gibt keine Eintr√§ge zum Exportieren.");
        return;
      }

      const header = [
        "Datum",
        "Stimmung",
        "Konzentration",
        "√úberreizung Vormittag",
        "√úberreizung Abend",
        "Ausbr√ºche",
        "Kopfweh",
        "Bauchweh",
        "Schwindel",
        "Auff√§lligkeiten",
      ];

      const rows = cachedEntries.map((entry) => [
        entry.datum,
        entry.stimmung,
        entry.konz,
        entry.vorm,
        entry.abend,
        entry.ausbr ? "Ja" : "Nein",
        entry.kopfweh ? "Ja" : "Nein",
        entry.bauchweh ? "Ja" : "Nein",
        entry.schwindel ? "Ja" : "Nein",
        entry.auff?.replace(/\r?\n/g, " ").replace(/"/g, '""') || "",
      ]);

      const csv = [header, ...rows]
        .map((cols) =>
          cols
            .map((value) => {
              const stringValue = value.toString();
              if (/[,";\n]/.test(stringValue)) {
                return `"${stringValue.replace(/"/g, '""')}"`;
              }
              return stringValue;
            })
            .join(";")
        )
        .join("\n");

      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const downloadLink = document.createElement("a");
      downloadLink.href = URL.createObjectURL(blob);
      downloadLink.download = `medikinet-tagebuch_${formatDateInput(today)}.csv`;
      downloadLink.click();
      URL.revokeObjectURL(downloadLink.href);
    }

    async function deleteEntryByDate(entryDate) {
      if (!entryDate) return;
      const confirmDelete = window.confirm(`Eintrag vom ${entryDate} l√∂schen?`);
      if (!confirmDelete) return;

      toggleFormDisabled(true);
      setStatus(`L√∂sche Eintrag vom ${entryDate}‚Ä¶`, "info");

      try {
        const latest = await fetchFromJsonBin();
        const next = latest.filter((item) => item.datum !== entryDate);
        if (next.length === latest.length) {
          setStatus(`Kein Eintrag vom ${entryDate} gefunden.`, "error");
          return;
        }

        const saved = await pushToJsonBin(next);
        cachedEntries = saved;
        renderToDom(cachedEntries);
        setStatus(buildStatusSummary(cachedEntries), "success");
      } catch (error) {
        console.error("Fehler beim L√∂schen", error);
        setStatus(`L√∂schen fehlgeschlagen: ${error.message}`, "error");
      } finally {
        toggleFormDisabled(false);
      }
    }

    function handleEntryAction(event) {
      const button = event.target.closest('[data-action="delete-entry"]');
      if (!button) return;
      const { entryDate } = button.dataset;
      deleteEntryByDate(entryDate);
    }

    function ensureConfig() {
      if (!config || !config.binId || !config.masterKey) {
        setStatus(
          "Cloud-Konfiguration fehlt oder ist unvollst√§ndig. Bitte trage JSONBin-ID und API-Schl√ºssel in cloud-config.js ein.",
          "error"
        );
        toggleFormDisabled(true);
        renderToDom([]);
        return false;
      }
      return true;
    }

    async function bootstrap() {
      setDefaultDate();
      syncHistoryView();
      toggleFormDisabled(true);

      if (!ensureConfig()) {
        return;
      }

      form.addEventListener("submit", handleSubmit);
      resetBtn.addEventListener("click", handleReset);
      exportBtn.addEventListener("click", exportCsv);
      entriesBody.addEventListener("click", handleEntryAction);
      if (entriesList) {
        entriesList.addEventListener("click", handleEntryAction);
      }

      setStatus("Cloud verbunden. Eintr√§ge werden synchronisiert‚Ä¶", "info");

      try {
        await refreshEntries({ silent: true });
        setStatus(buildStatusSummary(cachedEntries), "success");
      } catch (error) {
        setStatus(`Laden fehlgeschlagen: ${error.message}`, "error");
      } finally {
        toggleFormDisabled(false);
      }
    }

    bootstrap();
  </script>

</body>
</html>
