<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Medikinet Tagebuch ‚Äì Cloud</title>
  <style>
    :root {
      color-scheme: light;
      font-family: "Segoe UI", system-ui, -apple-system, sans-serif;
      --bg: #f5f7fb;
      --fg: #1f2937;
      --card: #ffffff;
      --primary: #4f46e5;
      --primary-dark: #3b33c4;
      --border: #e2e7f5;
      --radius: 20px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 24px 16px 64px;
      background: var(--bg);
      color: var(--fg);
      display: flex;
      justify-content: center;
      min-height: 100vh;
    }

    .app {
      width: min(960px, 100%);
      display: grid;
      gap: 24px;
    }

    header {
      text-align: center;
      display: grid;
      gap: 12px;
    }

    header h1 {
      margin: 0;
      font-size: clamp(1.9rem, 2.6vw, 2.9rem);
    }

    header p {
      margin: 0;
      color: #4b5563;
      line-height: 1.5;
    }

    .card {
      background: var(--card);
      border-radius: var(--radius);
      padding: clamp(16px, 2vw, 28px);
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.08);
      display: grid;
      gap: 16px;
    }

    form {
      display: grid;
      gap: 18px;
    }

    .grid {
      display: grid;
      gap: 16px;
    }

    .grid.two {
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }

    label {
      display: grid;
      gap: 6px;
      font-weight: 600;
      font-size: 15px;
    }

    select,
    input[type="date"],
    textarea {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 12px;
      font: inherit;
      transition: border 0.2s, box-shadow 0.2s;
      background: #fdfdff;
    }

    select:focus,
    input[type="date"]:focus,
    textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.15);
    }

    textarea {
      min-height: 96px;
      resize: vertical;
    }

    .checkbox-row {
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 600;
      font-size: 15px;
    }

    .checkbox-row input {
      width: 20px;
      height: 20px;
      accent-color: var(--primary);
    }

    .actions {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: flex-end;
    }

    .history-actions {
      justify-content: space-between;
      align-items: center;
    }

    .history-meta {
      flex: 1;
      min-width: 200px;
      color: #4b5563;
      font-size: 0.9rem;
      font-weight: 600;
    }

    button {
      padding: 10px 16px;
      border-radius: 999px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.1s ease, box-shadow 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    button.primary {
      background: var(--primary);
      color: white;
      box-shadow: 0 10px 20px rgba(79, 70, 229, 0.25);
    }

    button.primary:hover {
      background: var(--primary-dark);
    }

    button.secondary {
      background: #e5e7ff;
      color: var(--primary);
    }

    button.danger {
      background: #fee2e2;
      color: #b91c1c;
    }

    button:active {
      transform: scale(0.98);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(79, 70, 229, 0.12);
      color: var(--primary);
      border-radius: 999px;
      padding: 6px 12px;
      font-weight: 600;
      font-size: 0.85rem;
      width: fit-content;
    }

    .info-banner {
      display: grid;
      gap: 4px;
      font-size: 0.95rem;
      padding: 12px 16px;
      border-radius: 12px;
      border: 1px solid rgba(79, 70, 229, 0.2);
      background: rgba(79, 70, 229, 0.08);
    }

    .status {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 16px;
      border-radius: 12px;
      font-weight: 600;
      line-height: 1.4;
    }

    .status[data-tone="info"] {
      background: #eef2ff;
      color: #3730a3;
    }

    .status[data-tone="success"] {
      background: #ecfdf5;
      color: #047857;
    }

    .status[data-tone="error"] {
      background: #fef2f2;
      color: #b91c1c;
    }

    .table-wrapper {
      border-radius: 16px;
      overflow-x: auto;
      background: rgba(79, 70, 229, 0.03);
      padding: 2px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.95rem;
      min-width: 720px;
    }

    th,
    td {
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      text-align: left;
    }

    th {
      background: #eef1ff;
      font-weight: 700;
    }

    tbody tr:hover {
      background: rgba(79, 70, 229, 0.05);
    }

    .empty-state {
      text-align: center;
      padding: 28px 16px;
      color: #6b7280;
      font-weight: 600;
    }

    .entries-list {
      display: none;
      gap: 12px;
    }

    .entry-card {
      border: 1px solid rgba(79, 70, 229, 0.12);
      border-radius: 16px;
      padding: 16px;
      background: white;
      display: grid;
      gap: 12px;
      box-shadow: 0 12px 24px rgba(15, 23, 42, 0.06);
    }

    .entry-card__header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 8px;
      font-weight: 700;
    }

    .entry-card__mood {
      color: var(--primary);
    }

    .entry-card dl {
      display: grid;
      gap: 8px;
      margin: 0;
    }

    .entry-card dl div {
      display: grid;
      gap: 4px;
    }

    .entry-card dt {
      font-weight: 600;
      color: #4b5563;
      font-size: 0.9rem;
    }

    .entry-card dd {
      margin: 0;
      font-size: 0.95rem;
      line-height: 1.4;
    }

    @media (max-width: 900px) {
      body {
        padding: 20px 14px 48px;
      }
    }

    @media (max-width: 720px) {
      .grid.two {
        grid-template-columns: 1fr;
      }

      .actions {
        justify-content: center;
      }

      .actions button {
        flex: 1 1 200px;
        justify-content: center;
      }

      .table-wrapper {
        display: none;
      }

      .entries-list {
        display: grid;
      }

      .history-meta {
        text-align: center;
      }
    }

    @media (max-width: 600px) {
      body {
        padding: 16px 12px 40px;
      }

      header p {
        font-size: 0.95rem;
      }
    }

    @media (max-width: 480px) {
      header h1 {
        font-size: 1.75rem;
      }

      .card {
        padding: 18px 16px;
      }

      button {
        width: 100%;
        justify-content: center;
      }

      .actions {
        gap: 10px;
      }
    }
  </style>
  <script src="./cloud-config.js"></script>
</head>
<body>
  <div class="app">
    <header>
      <h1>‚òÅÔ∏è Medikinet-Tagebuch (Cloud)</h1>
      <p>Diese Variante synchronisiert alle Eintr√§ge mit einem Supabase-Cloud-Speicher. Stelle sicher, dass deine Konfiguration gesetzt ist, bevor du beginnst.</p>
    </header>

    <section class="card" aria-labelledby="cloud-info">
      <div class="badge" id="cloud-info">Cloud-Speicher</div>
      <div class="info-banner">
        <strong>So funktioniert es:</strong>
        <span>‚Ä¢ Trage deine Supabase-Zugangsdaten in <code>cloud-config.js</code> ein (zu finden unter
          <em>Project Settings ‚Üí API</em> im Supabase-Dashboard).</span>
        <span>‚Ä¢ Aktiviere Zeilen-Sicherheit (RLS) und erlaube der Tabelle <code>medikinet_entries</code> anonyme Lese- und Schreibrechte.</span>
        <span>‚Ä¢ Jeder Eintrag wird anhand des Datums √ºberschrieben, falls bereits vorhanden.</span>
      </div>
      <div class="status" id="cloud-status" role="status" aria-live="polite" data-tone="info">Warte auf Konfiguration‚Ä¶</div>
    </section>

    <section class="card" aria-labelledby="tagebuch-form">
      <div class="badge" id="tagebuch-form">Heutiger Eintrag</div>
      <form id="entry-form">
        <div class="grid two">
          <label>
            Datum
            <input type="date" id="datum" name="datum" required />
          </label>
          <label>
            Stimmung
            <select id="stimmung" name="stimmung" required>
              <option value="üòä Sehr gut">üòä Sehr gut</option>
              <option value="üôÇ Gut">üôÇ Gut</option>
              <option value="üòê Neutral">üòê Neutral</option>
              <option value="‚òπÔ∏è Schwankend">‚òπÔ∏è Schwankend</option>
              <option value="üò£ Herausfordernd">üò£ Herausfordernd</option>
            </select>
          </label>
          <label>
            Konzentration (Schule)
            <select id="konz" name="konz" required>
              <option value="üòä Sehr fokussiert">üòä Sehr fokussiert</option>
              <option value="üôÇ Gut fokussiert">üôÇ Gut fokussiert</option>
              <option value="üòê Mittel">üòê Mittel</option>
              <option value="‚òπÔ∏è Schwierig">‚òπÔ∏è Schwierig</option>
              <option value="üò£ Kaum m√∂glich">üò£ Kaum m√∂glich</option>
            </select>
          </label>
          <label>
            √úberreizung (Vormittag)
            <select id="vorm" name="vorm" required>
              <option value="üòä Sehr ruhig">üòä Sehr ruhig</option>
              <option value="üôÇ Gut reguliert">üôÇ Gut reguliert</option>
              <option value="üòê Leicht angespannt">üòê Leicht angespannt</option>
              <option value="‚òπÔ∏è Deutlich angespannt">‚òπÔ∏è Deutlich angespannt</option>
              <option value="üò£ Stark √ºberreizt">üò£ Stark √ºberreizt</option>
            </select>
          </label>
          <label>
            √úberreizung (Abend)
            <select id="abend" name="abend" required>
              <option value="üòä Sehr ruhig">üòä Sehr ruhig</option>
              <option value="üôÇ Gut reguliert">üôÇ Gut reguliert</option>
              <option value="üòê Leicht angespannt">üòê Leicht angespannt</option>
              <option value="‚òπÔ∏è Deutlich angespannt">‚òπÔ∏è Deutlich angespannt</option>
              <option value="üò£ Stark √ºberreizt">üò£ Stark √ºberreizt</option>
            </select>
          </label>
        </div>

        <label class="checkbox-row">
          <input type="checkbox" id="ausbr" name="ausbr" />
          Auff√§llige Ausbr√ºche heute
        </label>

        <label>
          Auff√§lligkeiten &amp; Notizen
          <textarea id="auff" name="auff" placeholder="z. B. Kopfweh, Bauchweh, Einschlafschwierigkeiten..."></textarea>
        </label>

        <div class="actions">
          <button type="button" class="secondary" id="reset-btn">Formular leeren</button>
          <button type="button" class="danger" id="delete-all-btn">Alle Eintr√§ge l√∂schen</button>
          <button type="submit" class="primary">‚òÅÔ∏è Eintrag speichern</button>
        </div>
      </form>
    </section>

    <section class="card" aria-labelledby="history-title">
      <div class="badge" id="history-title">Verlauf</div>
      <div class="actions history-actions">
        <span class="history-meta" id="history-meta" aria-live="polite"></span>
        <button type="button" class="secondary" id="export-btn">üìÅ Verlauf als CSV</button>
      </div>
      <div class="table-wrapper" aria-hidden="false">
        <table aria-live="polite" aria-describedby="history-title">
          <thead>
            <tr>
              <th>Datum</th>
              <th>Stimmung</th>
              <th>Konzentration</th>
              <th>√úberreizung (VM)</th>
              <th>√úberreizung (Ab)</th>
              <th>Ausbr√ºche</th>
              <th>Notizen</th>
            </tr>
          </thead>
          <tbody id="entries-body"></tbody>
        </table>
      </div>
      <div class="entries-list" id="entries-list" role="list" aria-live="polite" aria-hidden="true"></div>
    </section>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.43.2/+esm";

    const config = window.MEDIKINET_CLOUD_CONFIG;
    const form = document.getElementById("entry-form");
    const entriesBody = document.getElementById("entries-body");
    const entriesList = document.getElementById("entries-list");
    const historyMeta = document.getElementById("history-meta");
    const deleteAllBtn = document.getElementById("delete-all-btn");
    const resetBtn = document.getElementById("reset-btn");
    const exportBtn = document.getElementById("export-btn");
    const cloudStatus = document.getElementById("cloud-status");
    const tableWrapper = document.querySelector(".table-wrapper");

    const fields = [
      "datum",
      "stimmung",
      "konz",
      "vorm",
      "abend",
      "ausbr",
      "auff",
    ];

    const today = new Date();
    let supabase;
    let cachedEntries = [];

    const mobileQuery = window.matchMedia("(max-width: 720px)");

    function formatDateInput(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, "0");
      const day = String(date.getDate()).padStart(2, "0");
      return `${year}-${month}-${day}`;
    }

    function setDefaultDate() {
      const dateInput = document.getElementById("datum");
      if (!dateInput.value) {
        dateInput.value = formatDateInput(today);
      }
    }

    function setStatus(message, tone = "info") {
      if (!cloudStatus) return;
      cloudStatus.textContent = message;
      cloudStatus.setAttribute("data-tone", tone);
    }

    function toggleFormDisabled(disabled) {
      const controls = form?.querySelectorAll("input, select, textarea, button");
      controls?.forEach((control) => {
        control.disabled = disabled;
      });
    }

    function syncHistoryView() {
      const hideTable = mobileQuery.matches;
      if (tableWrapper) {
        tableWrapper.setAttribute("aria-hidden", hideTable ? "true" : "false");
      }
      if (entriesList) {
        entriesList.setAttribute("aria-hidden", hideTable ? "false" : "true");
      }
    }

    if (mobileQuery.addEventListener) {
      mobileQuery.addEventListener("change", syncHistoryView);
    } else if (mobileQuery.addListener) {
      mobileQuery.addListener(syncHistoryView);
    }

    function normalizeEntry(entry) {
      return {
        datum: entry.datum ?? "",
        stimmung: entry.stimmung ?? "",
        konz: entry.konz ?? "",
        vorm: entry.vorm ?? "",
        abend: entry.abend ?? "",
        ausbr: Boolean(entry.ausbr),
        auff: entry.auff ?? "",
      };
    }

    function updateHistoryMeta(entries) {
      if (!historyMeta) return;
      if (!entries.length) {
        historyMeta.textContent = "Noch keine Eintr√§ge";
        return;
      }
      const first = entries[0]?.datum;
      const last = entries[entries.length - 1]?.datum;
      historyMeta.textContent = `Synchronisiert: ${entries.length} Eintr√§ge (${first} bis ${last})`;
    }

    function renderToDom(entries) {
      entriesBody.innerHTML = "";
      if (entriesList) {
        entriesList.innerHTML = "";
      }

      if (!entries.length) {
        entriesBody.innerHTML = `<tr class="empty-state"><td colspan="7">Noch keine Eintr√§ge gespeichert.</td></tr>`;
        if (entriesList) {
          entriesList.innerHTML = `<p class="empty-state" role="status">Noch keine Eintr√§ge gespeichert.</p>`;
        }
        updateHistoryMeta(entries);
        return;
      }

      for (const entry of entries) {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${entry.datum}</td>
          <td>${entry.stimmung}</td>
          <td>${entry.konz}</td>
          <td>${entry.vorm}</td>
          <td>${entry.abend}</td>
          <td>${entry.ausbr ? "‚úÖ Ja" : "‚ûñ Nein"}</td>
          <td>${entry.auff ? entry.auff.replace(/\n/g, "<br>") : ""}</td>
        `;
        entriesBody.appendChild(row);

        if (entriesList) {
          const card = document.createElement("article");
          card.className = "entry-card";
          card.setAttribute("role", "listitem");
          const notes = entry.auff ? entry.auff.replace(/\n/g, "<br>") : "Keine Notizen";
          card.innerHTML = `
            <div class="entry-card__header">
              <span class="entry-card__date">${entry.datum}</span>
              <span class="entry-card__mood">${entry.stimmung}</span>
            </div>
            <dl>
              <div>
                <dt>Konzentration</dt>
                <dd>${entry.konz}</dd>
              </div>
              <div>
                <dt>√úberreizung (Vormittag)</dt>
                <dd>${entry.vorm}</dd>
              </div>
              <div>
                <dt>√úberreizung (Abend)</dt>
                <dd>${entry.abend}</dd>
              </div>
              <div>
                <dt>Ausbr√ºche</dt>
                <dd>${entry.ausbr ? "‚úÖ Ja" : "‚ûñ Nein"}</dd>
              </div>
              <div>
                <dt>Notizen</dt>
                <dd>${notes}</dd>
              </div>
            </dl>
          `;
          entriesList.appendChild(card);
        }
      }

      updateHistoryMeta(entries);
    }

    async function fetchEntries() {
      const { data, error } = await supabase
        .from(config.table)
        .select("datum, stimmung, konz, vorm, abend, ausbr, auff")
        .order("datum", { ascending: true });
      if (error) throw error;
      return data.map(normalizeEntry);
    }

    async function renderEntries() {
      if (!supabase) return;
      setStatus("Synchronisiere Eintr√§ge‚Ä¶", "info");
      try {
        cachedEntries = await fetchEntries();
        renderToDom(cachedEntries);
        setStatus(`Cloud synchronisiert (${cachedEntries.length} Eintr√§ge).`, "success");
      } catch (error) {
        console.error("Fehler beim Laden", error);
        renderToDom([]);
        setStatus(`Fehler beim Laden: ${error.message}`, "error");
      }
    }

    function readFormData() {
      const formData = new FormData(form);
      const entry = {};
      for (const field of fields) {
        if (field === "ausbr") {
          entry[field] = formData.get(field) === "on";
        } else {
          entry[field] = (formData.get(field) || "").toString().trim();
        }
      }
      return entry;
    }

    async function handleSubmit(event) {
      event.preventDefault();
      if (!supabase) return;
      const entry = readFormData();
      toggleFormDisabled(true);
      setStatus("Speichere Eintrag in der Cloud‚Ä¶", "info");
      try {
        const { error } = await supabase
          .from(config.table)
          .upsert([entry], { onConflict: "datum" });
        if (error) throw error;
        setStatus("Eintrag gespeichert.", "success");
        form.reset();
        setDefaultDate();
        await renderEntries();
      } catch (error) {
        console.error("Fehler beim Speichern", error);
        setStatus(`Speichern fehlgeschlagen: ${error.message}`, "error");
      } finally {
        toggleFormDisabled(false);
      }
    }

    async function handleDeleteAll() {
      if (!supabase) return;
      const confirmDelete = window.confirm("Sollen wirklich alle Eintr√§ge in der Cloud gel√∂scht werden?");
      if (!confirmDelete) return;
      toggleFormDisabled(true);
      setStatus("L√∂sche alle Cloud-Eintr√§ge‚Ä¶", "info");
      try {
        const { error } = await supabase.from(config.table).delete().neq("datum", "");
        if (error) throw error;
        cachedEntries = [];
        renderToDom([]);
        setStatus("Alle Eintr√§ge gel√∂scht.", "success");
      } catch (error) {
        console.error("Fehler beim L√∂schen", error);
        setStatus(`L√∂schen fehlgeschlagen: ${error.message}`, "error");
      } finally {
        toggleFormDisabled(false);
      }
    }

    function handleReset() {
      form.reset();
      setDefaultDate();
    }

    function exportCsv() {
      if (!cachedEntries.length) {
        alert("Es gibt keine Eintr√§ge zum Exportieren.");
        return;
      }

      const header = [
        "Datum",
        "Stimmung",
        "Konzentration",
        "√úberreizung Vormittag",
        "√úberreizung Abend",
        "Ausbr√ºche",
        "Auff√§lligkeiten",
      ];

      const rows = cachedEntries.map((entry) => [
        entry.datum,
        entry.stimmung,
        entry.konz,
        entry.vorm,
        entry.abend,
        entry.ausbr ? "Ja" : "Nein",
        entry.auff?.replace(/\r?\n/g, " ").replace(/"/g, '""') || "",
      ]);

      const csv = [header, ...rows]
        .map((cols) =>
          cols
            .map((value) => {
              const stringValue = value.toString();
              if (/[,";\n]/.test(stringValue)) {
                return `"${stringValue.replace(/"/g, '""')}"`;
              }
              return stringValue;
            })
            .join(";")
        )
        .join("\n");

      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const downloadLink = document.createElement("a");
      downloadLink.href = URL.createObjectURL(blob);
      downloadLink.download = `medikinet-tagebuch_${formatDateInput(today)}.csv`;
      downloadLink.click();
      URL.revokeObjectURL(downloadLink.href);
    }

    function ensureConfig() {
      if (!config || !config.supabaseUrl || !config.supabaseKey || !config.table) {
        setStatus("Cloud-Konfiguration fehlt oder ist unvollst√§ndig. Bitte passe cloud-config.js an.", "error");
        toggleFormDisabled(true);
        renderToDom([]);
        return false;
      }
      return true;
    }

    async function bootstrap() {
      setDefaultDate();
      syncHistoryView();
      toggleFormDisabled(true);

      if (!ensureConfig()) {
        return;
      }

      supabase = createClient(config.supabaseUrl, config.supabaseKey, {
        auth: { persistSession: false },
      });

      form.addEventListener("submit", handleSubmit);
      deleteAllBtn.addEventListener("click", handleDeleteAll);
      resetBtn.addEventListener("click", handleReset);
      exportBtn.addEventListener("click", exportCsv);

      setStatus("Cloud verbunden. Eintr√§ge werden synchronisiert‚Ä¶", "info");
      try {
        await renderEntries();
      } finally {
        toggleFormDisabled(false);
      }
    }

    bootstrap();
  </script>
</body>
</html>
