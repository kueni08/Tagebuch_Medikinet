<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Medikinet Tagebuch</title>
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" href="icons/icon-192.svg" type="image/svg+xml" />
  <script src="cloud-config.js" defer></script>
  <script src="js/pwa.js" defer></script>
  <style>
    :root {
      color-scheme: light;
      font-family: "Segoe UI", system-ui, -apple-system, sans-serif;
      --bg: #f5f7fb;
      --fg: #1f2937;
      --card: #ffffff;
      --primary: #4f46e5;
      --primary-dark: #3b33c4;
      --border: #e2e7f5;
      --radius: 20px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 24px 16px 64px;
      background: var(--bg);
      color: var(--fg);
      display: flex;
      justify-content: center;
      min-height: 100vh;
    }

    .app {
      width: min(960px, 100%);
      display: grid;
      gap: 24px;
    }

    .app-nav {
      display: flex;
      gap: 12px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .app-nav a {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 10px 18px;
      border-radius: 999px;
      background: rgba(79, 70, 229, 0.12);
      color: var(--primary);
      text-decoration: none;
      font-weight: 600;
      font-size: 0.95rem;
      transition: background 0.2s, color 0.2s;
    }

    .app-nav a:hover,
    .app-nav a:focus-visible {
      background: rgba(79, 70, 229, 0.2);
      outline: none;
    }

    .app-nav a[aria-current="page"] {
      background: var(--primary);
      color: #ffffff;
      box-shadow: 0 12px 24px rgba(79, 70, 229, 0.25);
    }

    header {
      text-align: center;
      display: grid;
      gap: 12px;
    }

    header h1 {
      margin: 0;
      font-size: clamp(1.9rem, 2.6vw, 2.9rem);
    }

    header p {
      margin: 0;
      color: #4b5563;
      line-height: 1.5;
    }

    .card {
      background: var(--card);
      border-radius: var(--radius);
      padding: clamp(16px, 2vw, 28px);
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.08);
      display: grid;
      gap: 16px;
    }

    form {
      display: grid;
      gap: 18px;
    }

    .grid {
      display: grid;
      gap: 16px;
    }

    .grid.two {
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }

    label {
      display: grid;
      gap: 6px;
      font-weight: 600;
      font-size: 15px;
    }

    select,
    input[type="date"],
    textarea {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 12px;
      font: inherit;
      transition: border 0.2s, box-shadow 0.2s;
      background: #fdfdff;
    }

    select:focus,
    input[type="date"]:focus,
    textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.15);
    }

    textarea {
      min-height: 96px;
      resize: vertical;
    }

    .checkbox-row {
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 600;
      font-size: 15px;
    }

    .checkbox-row input {
      width: 20px;
      height: 20px;
      accent-color: var(--primary);
    }

    fieldset.checkbox-cluster {
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 14px 16px 18px;
      display: grid;
      gap: 12px;
    }

    fieldset.checkbox-cluster legend {
      font-weight: 700;
      font-size: 0.95rem;
      padding: 0 8px;
    }

    .checkbox-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 12px 18px;
    }

    .checkbox-grid .checkbox-row {
      padding: 4px 0;
    }

    .muted {
      color: #6b7280;
    }

    .actions {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: flex-end;
    }

    button {
      padding: 10px 16px;
      border-radius: 999px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.1s ease, box-shadow 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    button.primary {
      background: var(--primary);
      color: white;
      box-shadow: 0 10px 20px rgba(79, 70, 229, 0.25);
    }

    button.primary:hover {
      background: var(--primary-dark);
    }

    button.secondary {
      background: #e5e7ff;
      color: var(--primary);
    }

    button.ghost {
      background: transparent;
      color: var(--primary);
      padding-left: 0;
      padding-right: 0;
      box-shadow: none;
    }

    button.ghost:hover {
      text-decoration: underline;
    }

    button.danger {
      background: #fee2e2;
      color: #b91c1c;
    }

    button:active {
      transform: scale(0.98);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(79, 70, 229, 0.12);
      color: var(--primary);
      border-radius: 999px;
      padding: 6px 12px;
      font-weight: 600;
      font-size: 0.85rem;
      width: fit-content;
    }

    .info-banner {
      display: grid;
      gap: 4px;
      font-size: 0.95rem;
      padding: 12px 16px;
      border-radius: 12px;
      border: 1px solid rgba(79, 70, 229, 0.2);
      background: rgba(79, 70, 229, 0.08);
    }

    .info-banner .info-link {
      color: var(--primary);
      text-decoration: none;
      font-weight: 600;
      margin-top: 4px;
    }

    .info-banner .info-link:hover,
    .info-banner .info-link:focus-visible {
      text-decoration: underline;
      outline: none;
    }

    .config-source {
      font-size: 0.95rem;
      color: #4b5563;
    }

    .config-form {
      display: grid;
      gap: 16px;
      margin-top: 8px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }

    .config-fields {
      display: grid;
      gap: 12px;
    }

    .config-fields.three {
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }

    .config-form .field {
      display: grid;
      gap: 6px;
      font-weight: 600;
      font-size: 15px;
    }

    .config-form .field input {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 12px;
      font: inherit;
      background: #fdfdff;
      transition: border 0.2s, box-shadow 0.2s;
    }

    .config-form .field input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.15);
    }

    .config-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }

    .config-note {
      margin: 0;
      font-size: 0.92rem;
      color: #6b7280;
      line-height: 1.5;
    }

    .config-toggle {
      display: grid;
      gap: 12px;
      margin-top: 16px;
      padding: 16px;
      border-radius: 16px;
      border: 1px dashed rgba(79, 70, 229, 0.4);
      background: rgba(79, 70, 229, 0.08);
    }

    .config-toggle p {
      margin: 0;
      color: #4b5563;
      font-size: 0.95rem;
    }

    .status {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 16px;
      border-radius: 12px;
      font-weight: 600;
      line-height: 1.4;
    }

    .status[data-tone="info"] {
      background: #eef2ff;
      color: #3730a3;
    }

    .status[data-tone="success"] {
      background: #ecfdf5;
      color: #047857;
    }

    .status[data-tone="error"] {
      background: #fef2f2;
      color: #b91c1c;
    }

    .status[data-tone="warning"] {
      background: #fffbeb;
      color: #92400e;
    }

    @media (max-width: 900px) {
      body {
        padding: 20px 14px 48px;
      }
    }

    @media (max-width: 720px) {
      .app-nav {
        justify-content: center;
      }

      .app-nav a {
        flex: 1 1 100%;
      }

      .grid.two {
        grid-template-columns: 1fr;
      }

      .actions {
        justify-content: center;
      }

      .actions button {
        flex: 1 1 200px;
        justify-content: center;
      }
    }

    @media (max-width: 600px) {
      body {
        padding: 16px 12px 40px;
      }

      header p {
        font-size: 0.95rem;
      }
    }

    @media (max-width: 480px) {
      .app-nav a {
        flex-basis: 100%;
      }

      header h1 {
        font-size: 1.75rem;
      }

      .card {
        padding: 18px 16px;
      }

      button {
        width: 100%;
        justify-content: center;
      }

      .actions {
        gap: 10px;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <nav class="app-nav" aria-label="Hauptnavigation">
      <a href="index.html" aria-current="page">Tagebuch</a>
      <a href="stimmungsverlauf.html">Verlauf</a>
      <a href="cloud-guide.html">Cloud-Anleitung</a>
    </nav>
    <header>
      <h1>â˜ï¸ Medikinet-Tagebuch</h1>
      <p class="muted">Kurze Notizen fÃ¼r Stimmung, Fokus und Beobachtungen â€“ optimiert fÃ¼r unterwegs.</p>
    </header>

    <section class="card" aria-labelledby="tagebuch-form">
      <div class="badge" id="tagebuch-form">Heutiger Eintrag</div>
      <form id="entry-form">
        <div class="grid two">
          <label>
            Datum
            <input type="date" id="datum" name="datum" required />
          </label>
          <label>
            Dosierung
            <select id="dosierung" name="dosierung" required>
              <option value="5 mg">5 mg</option>
              <option value="10 mg">10 mg</option>
              <option value="15 mg">15 mg</option>
              <option value="20 mg">20 mg</option>
              <option value="25 mg">25 mg</option>
            </select>
          </label>
          <label>
            Stimmung
            <select id="stimmung" name="stimmung" required>
              <option value="ğŸ˜Š Sehr gut">ğŸ˜Š Sehr gut</option>
              <option value="ğŸ™‚ Gut">ğŸ™‚ Gut</option>
              <option value="ğŸ˜ Neutral">ğŸ˜ Neutral</option>
              <option value="â˜¹ï¸ Schwankend">â˜¹ï¸ Schwankend</option>
              <option value="ğŸ˜£ Herausfordernd">ğŸ˜£ Herausfordernd</option>
            </select>
          </label>
          <label>
            Konzentration (Morgen)
            <select id="konz_morgen" name="konz_morgen" required>
              <option value="ğŸ˜Š Sehr fokussiert">ğŸ˜Š Sehr fokussiert</option>
              <option value="ğŸ™‚ Gut fokussiert">ğŸ™‚ Gut fokussiert</option>
              <option value="ğŸ˜ Mittel">ğŸ˜ Mittel</option>
              <option value="â˜¹ï¸ Schwierig">â˜¹ï¸ Schwierig</option>
              <option value="ğŸ˜£ Kaum mÃ¶glich">ğŸ˜£ Kaum mÃ¶glich</option>
            </select>
          </label>
          <label>
            Konzentration (Nachmittag)
            <select id="konz_nachmittag" name="konz_nachmittag" required>
              <option value="ğŸ˜Š Sehr fokussiert">ğŸ˜Š Sehr fokussiert</option>
              <option value="ğŸ™‚ Gut fokussiert">ğŸ™‚ Gut fokussiert</option>
              <option value="ğŸ˜ Mittel">ğŸ˜ Mittel</option>
              <option value="â˜¹ï¸ Schwierig">â˜¹ï¸ Schwierig</option>
              <option value="ğŸ˜£ Kaum mÃ¶glich">ğŸ˜£ Kaum mÃ¶glich</option>
            </select>
          </label>
          <label>
            Ãœberreizung (Vormittag)
            <select id="vorm" name="vorm" required>
              <option value="ğŸ˜Š Sehr ruhig">ğŸ˜Š Sehr ruhig</option>
              <option value="ğŸ™‚ Gut reguliert">ğŸ™‚ Gut reguliert</option>
              <option value="ğŸ˜ Leicht angespannt">ğŸ˜ Leicht angespannt</option>
              <option value="â˜¹ï¸ Deutlich angespannt">â˜¹ï¸ Deutlich angespannt</option>
              <option value="ğŸ˜£ Stark Ã¼berreizt">ğŸ˜£ Stark Ã¼berreizt</option>
            </select>
          </label>
          <label>
            Ãœberreizung (Abend)
            <select id="abend" name="abend" required>
              <option value="ğŸ˜Š Sehr ruhig">ğŸ˜Š Sehr ruhig</option>
              <option value="ğŸ™‚ Gut reguliert">ğŸ™‚ Gut reguliert</option>
              <option value="ğŸ˜ Leicht angespannt">ğŸ˜ Leicht angespannt</option>
              <option value="â˜¹ï¸ Deutlich angespannt">â˜¹ï¸ Deutlich angespannt</option>
              <option value="ğŸ˜£ Stark Ã¼berreizt">ğŸ˜£ Stark Ã¼berreizt</option>
            </select>
          </label>
          <label>
            Hausaufgabenmenge
            <select id="hausaufgaben" name="hausaufgaben" required>
              <option value="ğŸ˜Œ Keine">ğŸ˜Œ Keine</option>
              <option value="ğŸ™‚ Wenige">ğŸ™‚ Wenige</option>
              <option value="ğŸ˜ Normal">ğŸ˜ Normal</option>
              <option value="â˜¹ï¸ Viele">â˜¹ï¸ Viele</option>
              <option value="ğŸ˜£ Sehr viele">ğŸ˜£ Sehr viele</option>
            </select>
          </label>
          <label>
            Appetit
            <select id="appetit" name="appetit" required>
              <option value="ğŸ­ Kaum Hunger">ğŸ­ Kaum Hunger</option>
              <option value="ğŸ° Wenig Hunger">ğŸ° Wenig Hunger</option>
              <option value="ğŸ± Normaler Hunger">ğŸ± Normaler Hunger</option>
              <option value="ğŸ¦Š GroÃŸer Hunger">ğŸ¦Š GroÃŸer Hunger</option>
              <option value="ğŸ» BÃ¤renhunger">ğŸ» BÃ¤renhunger</option>
            </select>
          </label>
        </div>

        <fieldset class="checkbox-cluster">
          <legend>Besondere Beobachtungen heute</legend>
          <div class="checkbox-grid">
            <label class="checkbox-row" for="ausbr">
              <input type="checkbox" id="ausbr" name="ausbr" />
              AuffÃ¤llige AusbrÃ¼che
            </label>
            <label class="checkbox-row" for="kopfweh">
              <input type="checkbox" id="kopfweh" name="kopfweh" />
              Kopfweh
            </label>
            <label class="checkbox-row" for="bauchweh">
              <input type="checkbox" id="bauchweh" name="bauchweh" />
              Bauchweh
            </label>
            <label class="checkbox-row" for="schwindel">
              <input type="checkbox" id="schwindel" name="schwindel" />
              Schwindel
            </label>
          </div>
        </fieldset>

        <label>
          AuffÃ¤lligkeiten &amp; Notizen
          <textarea id="auff" name="auff" placeholder="z. B. Kopfweh, Bauchweh, Einschlafschwierigkeiten..."></textarea>
        </label>

        <div class="actions">
          <button type="button" class="secondary" id="reset-btn">Formular leeren</button>
          <button type="submit" class="primary">â˜ï¸ Eintrag speichern</button>
        </div>
        <div class="status" id="cloud-status" role="status" aria-live="polite" data-tone="info">Bereit fÃ¼r neue EintrÃ¤ge.</div>
      </form>
    </section>
  </div>

    <script type="module">
    import {
      detectStorageSupport,
      getActiveConfig,
      readLocalEntries,
      writeLocalEntries,
      fetchEntriesFromJsonBin,
      pushEntriesToJsonBin,
      sortByDate,
      normalizeEntry,
    } from "./js/data-access.mjs";

    const form = document.getElementById("entry-form");
    const resetBtn = document.getElementById("reset-btn");
    const statusEl = document.getElementById("cloud-status");
    const dateField = document.getElementById("datum");
    const dosierungField = document.getElementById("dosierung");

    const DEFAULT_DOSING_VALUE = "10 mg";

    const fields = [
      "datum",
      "dosierung",
      "stimmung",
      "konz_morgen",
      "konz_nachmittag",
      "vorm",
      "abend",
      "hausaufgaben",
      "appetit",
      "ausbr",
      "kopfweh",
      "bauchweh",
      "schwindel",
      "auff",
    ];

    const booleanFields = new Set(["ausbr", "kopfweh", "bauchweh", "schwindel"]);

    const today = new Date();
    const storageAvailable = detectStorageSupport();

    let cachedEntries = [];
    let eventsBound = false;
    let storageMode = storageAvailable ? "local" : "memory";

    const { config: initialConfig } = getActiveConfig();
    let config = initialConfig;

    function setStatus(message, tone = "info") {
      if (!statusEl) return;
      statusEl.textContent = message;
      statusEl.setAttribute("data-tone", tone);
    }

    function formatDateInput(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, "0");
      const day = String(date.getDate()).padStart(2, "0");
      return `${year}-${month}-${day}`;
    }

    function setDefaultDate() {
      if (!dateField.value) {
        dateField.value = formatDateInput(today);
      }
    }

    function getSortedEntries(entries) {
      return entries.slice().filter((item) => item.datum).sort((a, b) => a.datum.localeCompare(b.datum));
    }

    function findPreviousEntry(entries, targetDate) {
      if (!entries.length) {
        return null;
      }
      const sorted = getSortedEntries(entries);
      if (!sorted.length) {
        return null;
      }
      if (!targetDate) {
        return sorted[sorted.length - 1];
      }
      for (let index = sorted.length - 1; index >= 0; index -= 1) {
        const entry = sorted[index];
        if (entry.datum && entry.datum < targetDate) {
          return entry;
        }
      }
      return sorted[sorted.length - 1];
    }

    function getFormControl(name) {
      if (!form?.elements) return null;
      if (typeof form.elements.namedItem === "function") {
        const control = form.elements.namedItem(name);
        if (control) {
          return control;
        }
      }
      return form.elements[name] || null;
    }

    function toControlArray(control) {
      if (!control) return [];
      if (typeof control.length === "number" && typeof control.item === "function") {
        return Array.from(control);
      }
      return [control];
    }

    function applyDefaultsFromLatestEntry(entries) {
      if (!form) return;
      const targetDate = dateField?.value || "";
      const previous = findPreviousEntry(entries, targetDate);

      if (!previous) {
        if (dosierungField && !dosierungField.value) {
          dosierungField.value = DEFAULT_DOSING_VALUE;
        }
        return;
      }

      for (const field of fields) {
        if (field === "datum") continue;

        const control = getFormControl(field);
        if (!control) continue;

        if (booleanFields.has(field)) {
          for (const element of toControlArray(control)) {
            if ("checked" in element) {
              element.checked = Boolean(previous[field]);
            }
          }
          continue;
        }

        const rawValue = previous[field];
        const fallbackValue = field === "dosierung" ? DEFAULT_DOSING_VALUE : "";
        const nextValue =
          rawValue !== undefined && rawValue !== null && rawValue !== ""
            ? rawValue
            : fallbackValue;
        const normalizedValue = typeof nextValue === "string" ? nextValue : nextValue?.toString?.() || "";

        for (const element of toControlArray(control)) {
          if ("value" in element) {
            element.value = normalizedValue;
          }
        }
      }
    }

    function readEntriesFromLocal() {
      const { entries } = readLocalEntries();
      return entries;
    }

    function writeEntriesLocally(entries, updatedAt = new Date().toISOString()) {
      if (!storageAvailable) {
        return;
      }
      writeLocalEntries(entries, updatedAt);
    }

    function normalizeAndSortEntries(entries) {
      return sortByDate(entries.map(normalizeEntry));
    }

    async function loadEntriesFromPreferredSource({ showStatus = true } = {}) {
      if (!config) {
        storageMode = storageAvailable ? "local" : "memory";
        const entries = readEntriesFromLocal();
        cachedEntries = entries;
        applyDefaultsFromLatestEntry(cachedEntries);
        if (showStatus) {
          if (storageAvailable) {
            setStatus("Bereit fÃ¼r neue EintrÃ¤ge.", "info");
          } else {
            setStatus("TemporÃ¤re Sicherung aktiv. Bitte zeitnah exportieren.", "warning");
          }
        }
        return entries;
      }

      if (showStatus) {
        setStatus("Synchronisiereâ€¦", "info");
      }

      try {
        const { entries, updatedAt } = await fetchEntriesFromJsonBin(config);
        storageMode = "cloud";
        cachedEntries = entries;
        writeEntriesLocally(entries, updatedAt);
        applyDefaultsFromLatestEntry(cachedEntries);
        if (showStatus) {
          setStatus("Bereit fÃ¼r neue EintrÃ¤ge.", "success");
        }
        return entries;
      } catch (error) {
        console.warn("Fehler beim Laden", error);
        storageMode = storageAvailable ? "local" : "memory";
        const entries = readEntriesFromLocal();
        cachedEntries = entries;
        applyDefaultsFromLatestEntry(cachedEntries);
        if (showStatus) {
          const tone = storageAvailable ? "warning" : "error";
          const message = storageAvailable
            ? "Synchronisierung derzeit nicht mÃ¶glich. EintrÃ¤ge werden weiterhin gesichert."
            : "Synchronisierung derzeit nicht mÃ¶glich. EintrÃ¤ge kÃ¶nnen nur temporÃ¤r gesichert werden.";
          setStatus(message, tone);
        }
        return entries;
      }
    }

    async function getEntriesForWrite() {
      if (cachedEntries.length) {
        return cachedEntries;
      }
      return loadEntriesFromPreferredSource({ showStatus: false });
    }

    async function persistEntries(entries) {
      const normalized = normalizeAndSortEntries(entries);
      if (!config) {
        storageMode = storageAvailable ? "local" : "memory";
        cachedEntries = normalized;
        if (storageAvailable) {
          writeEntriesLocally(normalized, new Date().toISOString());
          setStatus("Eintrag gespeichert.", "success");
        } else {
          setStatus(
            "Eintrag gespeichert. Bitte GerÃ¤t geÃ¶ffnet lassen, die Daten sind nur temporÃ¤r gesichert.",
            "warning"
          );
        }
        return normalized;
      }
      try {
        const { entries: saved, updatedAt } = await pushEntriesToJsonBin(config, normalized);
        storageMode = "cloud";
        cachedEntries = saved;
        writeEntriesLocally(saved, updatedAt);
        setStatus("Eintrag gespeichert.", "success");
        return saved;
      } catch (error) {
        console.error("Fehler beim Speichern", error);
        storageMode = storageAvailable ? "local" : "memory";
        cachedEntries = normalized;
        if (storageAvailable) {
          writeEntriesLocally(normalized, new Date().toISOString());
          setStatus("Eintrag gespeichert. Synchronisierung erfolgt automatisch, sobald verfÃ¼gbar.", "warning");
        } else {
          setStatus(
            "Speichern nicht mÃ¶glich: Synchronisierung fehlgeschlagen und keine lokale Sicherung verfÃ¼gbar.",
            "error"
          );
        }
        return normalized;
      }
    }

    function toggleFormDisabled(disabled) {
      const controls = form?.querySelectorAll("input, select, textarea, button");
      controls?.forEach((control) => {
        control.disabled = disabled;
      });
    }

    async function handleSubmit(event) {
      event.preventDefault();
      const formData = new FormData(form);
      const entry = {};

      for (const field of fields) {
        if (booleanFields.has(field)) {
          entry[field] = formData.get(field) === "on";
        } else {
          entry[field] = (formData.get(field) || "").toString().trim();
        }
      }

      entry.konz = entry.konz_morgen || entry.konz_nachmittag || entry.konz || "";
      if (!entry.dosierung) {
        entry.dosierung = DEFAULT_DOSING_VALUE;
      }

      toggleFormDisabled(true);
      const writingOnline = Boolean(config) && storageMode === "cloud";
      const hasReliableStorage = writingOnline || storageAvailable;
      const tone = hasReliableStorage ? "info" : "warning";
      const message = hasReliableStorage
        ? "Speichere Eintragâ€¦"
        : "Speichere Eintrag ohne dauerhafte Sicherungâ€¦";
      setStatus(message, tone);

      try {
        const latest = await getEntriesForWrite();
        const next = [...latest];
        const index = next.findIndex((item) => item.datum === entry.datum);
        if (index >= 0) {
          next[index] = entry;
        } else {
          next.push(entry);
        }
        const savedEntries = await persistEntries(next);
        cachedEntries = savedEntries;
        form.reset();
        setDefaultDate();
        applyDefaultsFromLatestEntry(savedEntries);
      } finally {
        toggleFormDisabled(false);
      }
    }

    function handleReset() {
      form.reset();
      setDefaultDate();
      applyDefaultsFromLatestEntry(cachedEntries);
    }

    function bindDiaryEvents() {
      if (eventsBound) return;
      form?.addEventListener("submit", handleSubmit);
      resetBtn?.addEventListener("click", handleReset);
      dateField?.addEventListener("change", () => applyDefaultsFromLatestEntry(cachedEntries));
      eventsBound = true;
    }

    async function startDiary() {
      bindDiaryEvents();
      setDefaultDate();
      applyDefaultsFromLatestEntry(cachedEntries);
      await loadEntriesFromPreferredSource({ showStatus: true });
    }

    startDiary();
  </script>

</body>
</html>
