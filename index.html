<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Medikinet Tagebuch</title>
  <style>
    :root {
      color-scheme: light;
      font-family: "Segoe UI", system-ui, -apple-system, sans-serif;
      --bg: #f5f7fb;
      --fg: #1f2937;
      --card: #ffffff;
      --primary: #4f46e5;
      --primary-dark: #3b33c4;
      --border: #e2e7f5;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 24px 16px 64px;
      background: var(--bg);
      color: var(--fg);
    }

    .app {
      max-width: 960px;
      margin: 0 auto;
      display: grid;
      gap: 24px;
    }

    header {
      text-align: center;
      display: grid;
      gap: 12px;
    }

    header h1 {
      margin: 0;
      font-size: clamp(1.8rem, 2.4vw, 2.8rem);
    }

    header p {
      margin: 0;
      color: #4b5563;
    }

    .card {
      background: var(--card);
      border-radius: 20px;
      padding: clamp(16px, 2vw, 28px);
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.08);
      display: grid;
      gap: 16px;
    }

    form {
      display: grid;
      gap: 18px;
    }

    .grid {
      display: grid;
      gap: 16px;
    }

    .grid.two {
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }

    label {
      display: grid;
      gap: 6px;
      font-weight: 600;
      font-size: 15px;
    }

    select,
    input[type="date"],
    textarea {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 12px;
      font: inherit;
      transition: border 0.2s, box-shadow 0.2s;
      background: #fdfdff;
    }

    select:focus,
    input[type="date"]:focus,
    textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.15);
    }

    textarea {
      min-height: 96px;
      resize: vertical;
    }

    .checkbox-row {
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 600;
      font-size: 15px;
    }

    .checkbox-row input {
      width: 20px;
      height: 20px;
      accent-color: var(--primary);
    }

    .actions {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: flex-end;
    }

    button {
      padding: 10px 16px;
      border-radius: 999px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.1s ease, box-shadow 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    button.primary {
      background: var(--primary);
      color: white;
      box-shadow: 0 10px 20px rgba(79, 70, 229, 0.25);
    }

    button.primary:hover {
      background: var(--primary-dark);
    }

    button.secondary {
      background: #e5e7ff;
      color: var(--primary);
    }

    button.danger {
      background: #fee2e2;
      color: #b91c1c;
    }

    button:active {
      transform: scale(0.98);
    }

    .storage-warning {
      background: #fef3c7;
      border: 1px solid #fcd34d;
      color: #92400e;
      padding: 12px 16px;
      border-radius: 12px;
      font-weight: 600;
      display: none;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
      line-height: 1.4;
    }

    .storage-warning svg {
      flex-shrink: 0;
    }

    .storage-warning.show {
      display: flex;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.95rem;
    }

    th,
    td {
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      text-align: left;
    }

    th {
      background: #eef1ff;
      font-weight: 700;
    }

    tbody tr:hover {
      background: rgba(79, 70, 229, 0.05);
    }

    .empty-state {
      text-align: center;
      padding: 28px 16px;
      color: #6b7280;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(79, 70, 229, 0.12);
      color: var(--primary);
      border-radius: 999px;
      padding: 6px 12px;
      font-weight: 600;
      font-size: 0.85rem;
    }

    @media (max-width: 600px) {
      body {
        padding: 16px;
      }

      .actions {
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>üßæ Medikinet-Tagebuch</h1>
      <p>Alle Eintr√§ge werden nur lokal im Browser gespeichert. Nutze das Formular, um Beobachtungen rund um die Medikamenteneinnahme festzuhalten.</p>
    </header>

    <section class="card" aria-labelledby="tagebuch-form">
      <div class="badge" id="tagebuch-form">Heutiger Eintrag</div>
      <form id="entry-form">
        <div class="grid two">
          <label>
            Datum
            <input type="date" id="datum" name="datum" required />
          </label>
          <label>
            Stimmung
            <select id="stimmung" name="stimmung" required>
              <option value="üòä Sehr gut">üòä Sehr gut</option>
              <option value="üôÇ Gut">üôÇ Gut</option>
              <option value="üòê Neutral">üòê Neutral</option>
              <option value="‚òπÔ∏è Schwankend">‚òπÔ∏è Schwankend</option>
              <option value="üò£ Herausfordernd">üò£ Herausfordernd</option>
            </select>
          </label>
          <label>
            Konzentration (Schule)
            <select id="konz" name="konz" required>
              <option value="üòä Sehr fokussiert">üòä Sehr fokussiert</option>
              <option value="üôÇ Gut fokussiert">üôÇ Gut fokussiert</option>
              <option value="üòê Mittel">üòê Mittel</option>
              <option value="‚òπÔ∏è Schwierig">‚òπÔ∏è Schwierig</option>
              <option value="üò£ Kaum m√∂glich">üò£ Kaum m√∂glich</option>
            </select>
          </label>
          <label>
            √úberreizung (Vormittag)
            <select id="vorm" name="vorm" required>
              <option value="üòä Sehr ruhig">üòä Sehr ruhig</option>
              <option value="üôÇ Gut reguliert">üôÇ Gut reguliert</option>
              <option value="üòê Leicht angespannt">üòê Leicht angespannt</option>
              <option value="‚òπÔ∏è Deutlich angespannt">‚òπÔ∏è Deutlich angespannt</option>
              <option value="üò£ Stark √ºberreizt">üò£ Stark √ºberreizt</option>
            </select>
          </label>
          <label>
            √úberreizung (Abend)
            <select id="abend" name="abend" required>
              <option value="üòä Sehr ruhig">üòä Sehr ruhig</option>
              <option value="üôÇ Gut reguliert">üôÇ Gut reguliert</option>
              <option value="üòê Leicht angespannt">üòê Leicht angespannt</option>
              <option value="‚òπÔ∏è Deutlich angespannt">‚òπÔ∏è Deutlich angespannt</option>
              <option value="üò£ Stark √ºberreizt">üò£ Stark √ºberreizt</option>
            </select>
          </label>
        </div>

        <label class="checkbox-row">
          <input type="checkbox" id="ausbr" name="ausbr" />
          Auff√§llige Ausbr√ºche heute
        </label>

        <label>
          Auff√§lligkeiten & Notizen
          <textarea id="auff" name="auff" placeholder="z. B. Kopfweh, Bauchweh, Einschlafschwierigkeiten..."></textarea>
        </label>

        <div class="actions">
          <button type="button" class="secondary" id="reset-btn">Formular leeren</button>
          <button type="button" class="danger" id="delete-all-btn">Alle Eintr√§ge l√∂schen</button>
          <button type="submit" class="primary">üíæ Eintrag speichern</button>
        </div>
      </form>
    </section>

    <section class="card" aria-labelledby="history-title">
      <div class="badge" id="history-title">Verlauf</div>
      <div class="storage-warning" id="storage-warning" role="status" aria-live="polite" aria-hidden="true">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="20" height="20" aria-hidden="true">
          <path fill-rule="evenodd" d="M9.401 1.173a1 1 0 0 1 1.198 0l7.2 5.4A1 1 0 0 1 18 7.4V17a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V7.4a1 1 0 0 1 .201-.827l7.2-5.4Zm.599 4.327a1 1 0 0 0-1 1v4.5a1 1 0 1 0 2 0v-4.5a1 1 0 0 0-1-1Zm0 9a1.25 1.25 0 1 0 0-2.5 1.25 1.25 0 0 0 0 2.5Z" clip-rule="evenodd" />
        </svg>
        <span>Hinweis: Der Browser erlaubt keinen Zugriff auf den lokalen Speicher. Eintr√§ge bleiben nur bis zum Schlie√üen der Seite erhalten.</span>
      </div>
      <div class="actions" style="justify-content: flex-start;">
        <button type="button" class="secondary" id="export-btn">üìÅ Verlauf als CSV</button>
      </div>
      <div class="table-wrapper">
        <table aria-live="polite" aria-describedby="history-title">
          <thead>
            <tr>
              <th>Datum</th>
              <th>Stimmung</th>
              <th>Konzentration</th>
              <th>√úberreizung (VM)</th>
              <th>√úberreizung (Ab)</th>
              <th>Ausbr√ºche</th>
              <th>Notizen</th>
            </tr>
          </thead>
          <tbody id="entries-body">
            <tr class="empty-state">
              <td colspan="7">Noch keine Eintr√§ge gespeichert.</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>
  </div>

  <script>
    const storageKey = "medikinetTagebuchEntries";
    const form = document.getElementById("entry-form");
    const entriesBody = document.getElementById("entries-body");
    const deleteAllBtn = document.getElementById("delete-all-btn");
    const resetBtn = document.getElementById("reset-btn");
    const exportBtn = document.getElementById("export-btn");
    const storageWarning = document.getElementById("storage-warning");

    const fields = [
      "datum",
      "stimmung",
      "konz",
      "vorm",
      "abend",
      "ausbr",
      "auff",
    ];

    const today = new Date();
    let storageAvailable = true;
    let memoryEntries = [];

    function showStorageWarning() {
      if (storageWarning) {
        storageWarning.classList.add("show");
        storageWarning.setAttribute("aria-hidden", "false");
      }
    }

    function disableStorage(error) {
      if (storageAvailable && error) {
        console.error("Lokaler Speicher nicht verf√ºgbar", error);
      }
      if (!storageAvailable) return;
      storageAvailable = false;
      showStorageWarning();
    }

    function detectStorageSupport() {
      if (typeof window === "undefined" || !("localStorage" in window)) {
        disableStorage(new Error("localStorage wird von diesem Kontext nicht unterst√ºtzt."));
        return false;
      }
      try {
        const testKey = "__medikinet_storage_test__";
        localStorage.setItem(testKey, "1");
        localStorage.removeItem(testKey);
        return true;
      } catch (error) {
        disableStorage(error);
        return false;
      }
    }

    storageAvailable = detectStorageSupport();

    function formatDateInput(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, "0");
      const day = String(date.getDate()).padStart(2, "0");
      return `${year}-${month}-${day}`;
    }

    function setDefaultDate() {
      const dateInput = document.getElementById("datum");
      if (!dateInput.value) {
        dateInput.value = formatDateInput(today);
      }
    }

    function readEntries() {
      if (!storageAvailable) {
        return [...memoryEntries];
      }
      try {
        const raw = localStorage.getItem(storageKey);
        return raw ? JSON.parse(raw) : [];
      } catch (error) {
        if (error instanceof SyntaxError) {
          console.warn("Eintr√§ge konnten nicht gelesen werden und werden zur√ºckgesetzt.", error);
          try {
            localStorage.removeItem(storageKey);
          } catch (removeError) {
            disableStorage(removeError);
            memoryEntries = [];
            return [];
          }
          return [];
        }
        disableStorage(error);
        memoryEntries = [];
        return [];
      }
    }

    function saveEntries(list) {
      if (!storageAvailable) {
        memoryEntries = [...list];
        return;
      }
      try {
        localStorage.setItem(storageKey, JSON.stringify(list));
      } catch (error) {
        memoryEntries = [...list];
        disableStorage(error);
      }
    }

    function renderEntries() {
      const entries = readEntries();
      entriesBody.innerHTML = "";

      if (!entries.length) {
        entriesBody.innerHTML = `<tr class="empty-state"><td colspan="7">Noch keine Eintr√§ge gespeichert.</td></tr>`;
        return;
      }

      for (const entry of entries) {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${entry.datum}</td>
          <td>${entry.stimmung}</td>
          <td>${entry.konz}</td>
          <td>${entry.vorm}</td>
          <td>${entry.abend}</td>
          <td>${entry.ausbr ? "‚úÖ Ja" : "‚ûñ Nein"}</td>
          <td>${entry.auff ? entry.auff.replace(/\n/g, "<br>") : ""}</td>
        `;
        entriesBody.appendChild(row);
      }
    }

    function handleSubmit(event) {
      event.preventDefault();
      const formData = new FormData(form);
      const entry = {};

      for (const field of fields) {
        if (field === "ausbr") {
          entry[field] = formData.get(field) === "on";
        } else {
          entry[field] = (formData.get(field) || "").toString().trim();
        }
      }

      const existing = readEntries();
      const index = existing.findIndex((item) => item.datum === entry.datum);

      if (index >= 0) {
        existing[index] = entry;
      } else {
        existing.push(entry);
        existing.sort((a, b) => (a.datum < b.datum ? -1 : 1));
      }

      saveEntries(existing);
      renderEntries();
      form.reset();
      setDefaultDate();
    }

    function handleDeleteAll() {
      const confirmDelete = window.confirm("Sollen wirklich alle Eintr√§ge gel√∂scht werden?");
      if (!confirmDelete) return;
      if (!storageAvailable) {
        memoryEntries = [];
      } else {
        try {
          localStorage.removeItem(storageKey);
        } catch (error) {
          memoryEntries = [];
          disableStorage(error);
        }
      }
      renderEntries();
      form.reset();
      setDefaultDate();
    }

    function handleReset() {
      form.reset();
      setDefaultDate();
    }

    function exportCsv() {
      const entries = readEntries();
      if (!entries.length) {
        alert("Es gibt keine Eintr√§ge zum Exportieren.");
        return;
      }

      const header = [
        "Datum",
        "Stimmung",
        "Konzentration",
        "√úberreizung Vormittag",
        "√úberreizung Abend",
        "Ausbr√ºche",
        "Auff√§lligkeiten",
      ];

      const rows = entries.map((entry) => [
        entry.datum,
        entry.stimmung,
        entry.konz,
        entry.vorm,
        entry.abend,
        entry.ausbr ? "Ja" : "Nein",
        entry.auff?.replace(/\r?\n/g, " ").replace(/"/g, '""') || "",
      ]);

      const csv = [header, ...rows]
        .map((cols) =>
          cols
            .map((value) => {
              const stringValue = value.toString();
              if (/[,";\n]/.test(stringValue)) {
                return `"${stringValue.replace(/"/g, '""')}"`;
              }
              return stringValue;
            })
            .join(";")
        )
        .join("\n");

      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const downloadLink = document.createElement("a");
      downloadLink.href = URL.createObjectURL(blob);
      downloadLink.download = `medikinet-tagebuch_${formatDateInput(today)}.csv`;
      downloadLink.click();
      URL.revokeObjectURL(downloadLink.href);
    }

    form.addEventListener("submit", handleSubmit);
    deleteAllBtn.addEventListener("click", handleDeleteAll);
    resetBtn.addEventListener("click", handleReset);
    exportBtn.addEventListener("click", exportCsv);

    setDefaultDate();
    renderEntries();
  </script>
</body>
</html>
